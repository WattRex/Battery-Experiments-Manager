{% extends "base.html" %}
{% load static %}

{% block page_content %}

    <style>
        #background-image {
            /*width: 50%;*/
            width: 85%;
            opacity: 0.25;
            -webkit-backface-visibility: hidden; 
            -ms-transform: translateZ(0); /* IE 9 */
            -webkit-transform: translateZ(0); /* Chrome, Safari, Opera */
            transform: translateZ(0);
            max-width: 500px;
            max-height: 756px;
            transform-origin: 50% 50%;
            -webkit-animation: blink-1 15s linear infinite both;
                    animation: blink-1 15s linear infinite both;
            -webkit-user-select: none; /* Chrome all / Safari all */
            -moz-user-select: none; /* Firefox all */
            -ms-user-select: none; /* IE 10+ */
            user-select: none; /* Likely future */
        }

        /*#background-image:hover {
            -webkit-animation: rotation 0.1s linear infinite;
                    animation: rotation 0.1s linear infinite;
        }*/

        {% if not live_graph %}
        .mainPanel {
            text-align: center !important;
        }
        {% endif %}

        #live-graph-panel h1, h2, h3, h4, h5, h6 {
            display: inline-block;
        }

        #live-graph-panel > div:first-of-type {
            float: right !important;
        }


        /* ----------------------------------------------
        * Generated by Animista on 2023-8-22 11:43:42
        * Licensed under FreeBSD License.
        * See http://animista.net/license for more info. 
        * w: http://animista.net, t: @cssanimista
        * ---------------------------------------------- */

        /**
        * ----------------------------------------
        * animation blink-1
        * ----------------------------------------
        */
        @-webkit-keyframes blink-1 {
        0%,
        50%,
        100% {
            opacity: 0.20;
            transform: scale(1);
        }
        25%,
        75% {
            opacity: 0.08;
            transform: scale(0.98);
        }
        }
        @keyframes blink-1 {
        0%,
        50%,
        100% {
            opacity: 0.20;
            transform: scale(1);
        }
        25%,
        75% {
            opacity: 0.08;
            transform: scale(0.98);
        }
        }

        @keyframes rotation {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(359deg);
            }
        }


    </style>

    <div class="container-fluid">
        <div class="row" style="height: 90vh;">
            <div class="col-md-4 col-lg-3 col-xl-2">
                <div class="vLeftMenu bg-light text-capitalize">

                    <ul class="vLeftMenu">
                        {% for cycle_station_on in cycle_stations_on %}
                            <a class="" href="{% url 'live_cycle_station' cycle_station_on.cs_id %}">
                                <li class="vLeftMenu On" {% if cycle_station_on.cs_id == id_selected %}id="myActiveVLeftMenu"{% endif %}>
                                    <span>{{ cycle_station_on.name }}</span>
                                </li>
                            </a>
                        {% endfor %}
                    </ul>

                </div>
            </div>

            <div class="col-md-8 col-lg-9 col-xl-10" id="mainPanel">
                <div class="bg-light mainPanel">
                    {% if live_graph %}
                        <div id="live-graph-panel">
                            <h2>{{ experiment_selected.exp_id }} - {{ experiment_selected.name }}</h2>
                            <div>
                                <label for="time_window" style="margin-right: 7px;">Load last: </label>
                                <select id="time_window" name="time_window" class=".selectpicker" data-size="8">
                                    <option value="30">30 seconds</option>
                                    <option value="60" selected>1 minute</option>
                                    <option value="300">5 minutes</option>
                                    <option value="600">10 minutes</option>
                                    <option value="900">15 minutes</option>
                                    <option value="1800">30 minutes</option>
                                    <option value="3600">1 hour</option>
                                </select>
                            </div>
                        </div>
                        {% comment %} The following 2 scripts are placed here to set custom select before graph is loaded to avoid visual glitches {% endcomment %}
                        <script type="text/javascript" src="{% static 'bootstrap-select/js/bootstrap-select.min.js'%}"></script>
                        <script>
                            var time_window_select_picker = $('#time_window').selectpicker();
                        </script>
                        <div>
                            {{ live_graph|safe }}
                            <h5>Ongoing instruction <span id="actual-instr">{{profile.last_instr}}</span> of {{profile.total_n_instr}} â†’ {{profile.instr}}</h5>
                        </div>
                    {% else %}
                        <img draggable="false" id="background-image" src="{% static 'images/WATREX_LOGO_no_color.svg' %}" alt="background_image">
                    {% endif %}
                </div>

            </div>
        </div>
    </div>

    {% if live_graph %}
        <script>
            const EXP_ID = {{ experiment_selected.exp_id }};
            var time_window_select = document.getElementById("time_window");
            var time_interval = window.setInterval(updateGraph, 5000);
            var used_meas_ids_and_names = {{ used_meas_ids_and_names | safe}}
            // console.log(used_meas_ids_and_names);

            // Add event listener to time window select to update the graph depending on the selected time window value
            time_window.addEventListener("change", function() {
                let new_meas = null;
                let new_meas_ids = null;
                var time_window = document.getElementById("time_window").value;
                $.ajax({
                    async: false,
                    type: "POST",
                    url: "{% url 'get-new-graph' %}",   
                    // contentType: "application/json; charset=utf-8",
                    data: { csrfmiddlewaretoken: '{{ csrf_token }}',
                            experiment_id: EXP_ID,
                            meas_numeric_list: JSON.stringify(meas_numeric_list),
                            time_window: time_window,
                        },
                    success:  function(response){
                        new_meas = JSON.parse(response)['newMeas']
                        new_meas_ids = JSON.parse(response)['newMeasIds']
                        console.log(new_meas_ids);
                    },
                });
                for (let trace of graph.data) {
                    trace.x = new_meas_ids;
                    // console.log(trace.name);
                    let meas_index = null;
                    if (trace.name == 'Voltage') {
                        trace.y = new_meas['Voltage'];
                        // meas_index = 0;
                    } 
                    else if (trace.name == 'Current') {
                        trace.y = new_meas['Current'];
                        // meas_index = 1;
                    }
                    else {
                        // number_meas = meas_numeric_list[meas_names_list.indexOf(trace.name)];
                        number_meas = trace.text.substring(3);
                        trace.y = new_meas[number_meas];
                    }
                }
                // console.log(graph.layout.xaxis.range);
                {% comment %} if (last_meas_id_on_graph > graph.layout.xaxis.range[0] && last_meas_id_on_graph < graph.layout.xaxis.range[1]){
                    // console.log('inside_range');
                    graph.layout.xaxis.range[0] += new_meas_ids.length;
                    graph.layout.xaxis.range[1] += new_meas_ids.length;
                } {% endcomment %}
                Plotly.update(graph.id, graph.data, graph.layout);
            });
            
            var graph = document.getElementById("graphLive");
            var meas_names_list = [];
            var meas_numeric_list = [];
            for (let trace of graph.data) {
                meas_names_list.push(trace.name);
                if (trace.text) {
                    meas_numeric_list.push(trace.text.substring(3));
                } else {
                    meas_numeric_list.push(-1);
                }
            }
            console.log(meas_names_list);
            console.log(meas_numeric_list);

            // // Initial ajax call to get the measures names and their numeric value
            // $.ajax({
            //     async: false,
            //     type: "POST",
            //     url: "{% url 'translate-measures-names' %}",   
            //     // contentType: "application/json; charset=utf-8",
            //     data: { csrfmiddlewaretoken: '{{ csrf_token }}',
            //             measures_names: JSON.stringify(meas_names_list),
            //             exp_id: EXP_ID,
            //         },
            //     success:  function(response){
            //         meas_numeric_list = JSON.parse(response)['meas_numeric_list']
            //         // console.log(meas_numeric_list);
            //     },
            // });
            // for (let meas_name of meas_names_list) {
            //     let generic_meas_names_list = ['Voltage', 'voltage', 'Current', 'current'];
            //     if (generic_meas_names_list.includes(meas_name)) {
            //         meas_numeric_list.push(-1);
            //     }
            //     else {
            //         meas_numeric_list.push(used_meas_ids_and_names[meas_name]);
            //         console.log();
            //         for (let used_meas_id of Object.keys(used_meas_ids_and_names)) {
            //             console.log(used_meas_ids_and_names[used_meas_id])
            //         }
            //     }
            // }


            function updateGraph() {
                let new_meas = null;
                let new_meas_ids = null;
                let actual_instr = null;
                // console.log(graph.data);
                let last_meas_id_on_graph = graph.data[0].x[graph.data[0].x.length - 1];
                console.log(graph.data[0]);
                console.log(last_meas_id_on_graph);
                $.ajax({
                    async: false,
                    type: "POST",
                    url: "{% url 'get-new-measures' %}",   
                    // contentType: "application/json; charset=utf-8",
                    data: { csrfmiddlewaretoken: '{{ csrf_token }}',
                            experiment_id: EXP_ID,
                            last_meas_id: last_meas_id_on_graph,
                            meas_numeric_list: JSON.stringify(meas_numeric_list),
                        },
                    success:  function(response){
                        new_meas = JSON.parse(response)['newMeas'];
                        new_meas_ids = JSON.parse(response)['newMeasIds'];
                        actual_instr = JSON.parse(response)['actualInstruction'];
                        // console.log(new_meas);
                        // console.log(new_meas_ids);
                    },
                });

                if (actual_instr != null) {
                    document.getElementById("actual-instr").innerHTML = actual_instr;
                }
                if (new_meas_ids != null) {
                    for (let trace of graph.data) {
                        trace.x = trace.x.concat(new_meas_ids);
                        // console.log(trace.name);
                        let meas_index = null;
                        if (trace.name == 'Voltage') {
                            trace.y = trace.y.concat(new_meas['Voltage']);
                            // meas_index = 0;
                        } 
                        else if (trace.name == 'Current') {
                            trace.y = trace.y.concat(new_meas['Current']);
                            // meas_index = 1;
                        }
                        else {
                            // number_meas = meas_numeric_list[meas_names_list.indexOf(trace.name)];
                            number_meas = trace.text.substring(3);
                            trace.y = trace.y.concat(new_meas[number_meas]);
                        }
                    }
                    // console.log(graph.layout.xaxis.range);
                    if (last_meas_id_on_graph > graph.layout.xaxis.range[0] && last_meas_id_on_graph < graph.layout.xaxis.range[1]){
                        // console.log('inside_range');
                        graph.layout.xaxis.range[0] += new_meas_ids.length;
                        graph.layout.xaxis.range[1] += new_meas_ids.length;
                    }
                    Plotly.update(graph.id, graph.data, graph.layout);
                }
            }

            function KeyPress(e) {
                var evtobj = window.event? event : e
                if (evtobj.key == 'p' && evtobj.ctrlKey && evtobj.altKey){
                    window.clearInterval(time_interval);
                    console.log('clear_interval');
                }
                if (evtobj.key == 'r' && evtobj.ctrlKey && evtobj.altKey){
                    time_interval = window.setInterval(updateGraph, 5000);
                    console.log('set_interval');
                }
            }
            document.onkeydown = KeyPress;
        </script>
    {% endif %}

{% endblock %}
